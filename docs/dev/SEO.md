# SEO & SMO Operations Guide

This document captures the conventions that keep Apotheon.ai's marketing surfaces
search-friendly without sacrificing automation. Treat the guidance below as the
source of truth when extending metadata, structured data, or search artifacts.

## Centralised metadata utility

All layout metadata flows through [`src/utils/seo.ts`](../../src/utils/seo.ts).
Use the exported `createPageSeo` helper to derive canonical URLs, OpenGraph
payloads, Twitter cards, and hreflang alternates. The utility handles trailing
slash normalisation, locale defaults, and noindex directives, so avoid building
meta tags manually in templates.

```ts
const seo = createPageSeo(
  {
    title: 'Solutions',
    description: 'Launch-ready accelerators.',
    path: '/solutions/',
    openGraph: {
      type: 'website',
      images: [{ url: 'https://apotheon.ai/static/diagrams/solutions/atlas.svg' }],
    },
  },
  { site: Astro.site ?? Astro.url },
);
```

`BaseLayout.astro` consumes this output and renders deterministic head markup.
When you need to override metadata for a route, pass overrides via the `seo`
prop exposed by `MarketingShell` or call `createPageSeo` directly if you are
using the base layout without an intermediate shell.

## Structured data builders

Structured data is composed with the JSON-LD helpers in `src/utils/seo.ts`:

- `buildOrganizationSchema` and `buildWebsiteSchema` power the homepage.
- `buildBreadcrumbSchema` mirrors the navigation trails generated by
  `src/utils/breadcrumbs.ts`.
- `buildSoftwareApplicationSchema` represents `/solutions/*` entries.
- `buildArticleSchema` covers blog posts, pulling publish/updated dates from the
  content collection.
- `buildFaqSchema` is available for routes like `/about/contact/` where the page
  answers common questions inline.

Inject the resulting payloads with `SchemaScript`:

```astro
<SchemaScript slot="head" schema={[softwareSchema, breadcrumbSchema]} />
```

Always reuse the canonical breadcrumbs generated by the helper functions. When
adding new schema types, define a builder in `src/utils/seo.ts` and cover it with
Vitest assertions so future refactors remain safe.

## Canonical overrides

Most routes inherit canonical slugs from `Astro.url.pathname`. If a page must
canonicalise to a different host or path, provide `canonicalUrl` inside the
`seo` object. The helper ensures all downstream metadata (OpenGraph, Twitter,
hreflang) references the override. Avoid sprinkling `link[rel="canonical"]`
tag generation outside `BaseLayout`; that prevents drift.

## Sitemap and robots automation

`scripts/seo/generate-sitemap.mjs` inspects the static `dist/` output, merges in
blog publish dates from the content collection, and emits chunked sitemap files
alongside `sitemap-index.xml`. `scripts/seo/generate-robots.mjs` reads the same
manifest and injects `Sitemap:` pointers for every generated XML file. Both
scripts run via `npm run build` so the artefacts stay fresh on every deploy.

## Pagefind canonical URLs

After Pagefind indexes the site, `scripts/search/postbuild.mjs` re-reads each
result and rewrites the stored URL to the canonical slug from the HTML head.
This prevents search hits from surfacing `/index.html` or other non-canonical
variants. Keep this enforcement in mind when adding new dynamic routesâ€”the
canonical link in the HTML is the single source of truth.

## Validation workflows

Run the following commands before merging SEO-affecting changes:

- `npm run lint`
- `npm run typecheck`
- `npm run test` (executes Vitest and component smoke tests)
- `npm run test:e2e` (Playwright assertions check canonical links and schema)
- `npm run build` (generates sitemap/robots and rebuilds the Pagefind index)
- `npm run ladle:build`
- `npm run lighthouse:ci` (refreshes performance/SEO budgets)

CI also executes `npm run seo:verify`, which now checks that every HTML page has
a canonical link, meta description, and at least one JSON-LD script. Use the
command locally if you touch layout logic or content collections.

When introducing new schema objects or metadata hooks, update this document with
the rationale so future contributors maintain parity between templates,
automation, and smoke tests.
