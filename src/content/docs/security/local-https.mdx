---
title: Local HTTPS + CSP Validation Playbook
category: security
categoryLabel: Security
description: Enterprise QA requires parity with production transport security.
  The workflow below automates certificate management, Astro dev server
  configuration, and CSP report capture so engineers can exercise real-world
  browser behaviour before shipping.
sourcePath: security/LOCAL_HTTPS.md
sourceLastModified: 2025-09-30T04:05:36.323Z
tags: []
---

Enterprise QA requires parity with production transport security. The workflow
below automates certificate management, Astro dev server configuration, and CSP
report capture so engineers can exercise real-world browser behaviour before
shipping.

## 1. Install mkcert root CA (one-time)

```bash
./scripts/security/mkcert-install.sh
```

This script wraps `mkcert -install` and ensures the local trust store is primed
for development certificates. Run it again whenever the root CA expires or if a
new developer workstation comes online.

## 2. Mint localhost certificates

```bash
./scripts/security/mkcert-localhost.sh
```

The helper drops `certs/localhost-cert.pem` and `certs/localhost-key.pem`, the
same paths consumed by both the Astro dev server and future reverse proxies. You
can regenerate the pair at any time; the script overwrites existing files.

## 3. Launch Astro with HTTPS + CSP reporting

```bash
npm run dev:https
```

`scripts/dev-https.mjs` automatically:

- exports `ASTRO_DEV_HTTPS=true` so `astro.config.mjs` enables HTTPS
- feeds the mkcert certificates to `astro dev` (or falls back to Vite's
  self-signed cert when none exist)
- toggles `ASTRO_CSP_REPORT_ONLY=true` by default so browsers surface CSP
  violations without blocking the page

Pass additional flags directly (for example, `npm run dev:https -- --open`).

## 4. Review CSP violations locally

While the dev server runs, open https://localhost:4321/ in a browser. Inline
scripts/styles should hydrate using the nonce emitted by
`src/middleware/security.ts`. Inspect `Application → Storage → Reporting API` or
watch the terminal where `npm run dev:https` executes; violations are printed to
stdout until the Cloudflare Worker is deployed.

## 5. Wire CSP reporting in Cloudflare later

`workers/csp-report-handler.ts` is a stub Worker that captures POSTed
`application/csp-report` payloads. Deploy it behind a Pages/Worker route like
`/api/security/csp-report` and bind storage (KV, Queue, R2, etc.) when ready for
centralized telemetry.

## 6. Troubleshooting checklist

- Certificate mismatch? Regenerate them with
  `./scripts/security/mkcert-localhost.sh` and restart the dev server.
- Browser still flags the cert as untrusted? Re-run
  `./scripts/security/mkcert-install.sh` to re-seed the mkcert root CA.
- Need to force strict CSP even in dev? Set `ASTRO_CSP_REPORT_ONLY=false` when
  running `npm run dev:https`.

## 7. Regenerate legal policy surfaces alongside HTTPS reviews

When privacy counsel ships updated terms, follow this workflow so the static
site and JSON-LD payloads stay synchronized:

1. Duplicate the existing policy file in `src/pages/legal/` as a working copy.
2. Update the prose, ensure the `lastUpdated` constant reflects the effective
   date, and keep DSAR anchors (`id="dsar-workflow"`) intact for Playwright
   regression tests.
3. Refresh the Policy JSON-LD payload passed to `<SchemaScript>` with the new
   summary, canonical URL, and modification date.
4. Run the full validation suite:
   - `npm run lint`
   - `npm run typecheck`
   - `npm run test`
   - `npm run test:e2e`
5. Capture any consent-related changes in
   `config/privacy/klaro.config.ts` so the cookie policy’s Klaro link remains
   accurate.

Because the consent banner relies on HTTPS to exercise Secure and SameSite
cookies correctly, run `npm run dev:https` during validation to mirror
production transport guarantees.
